name: Essential Papers Collection

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level for execution'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR
  push:
    branches: [ main ]
    paths:
      - 'pyproject.toml' # 의존성 파일을 pyproject.toml로 변경
      - 'uv.lock' # lock 파일도 변경 사항을 감지하도록 추가
      - 'config/**'
      - 'src/**'
      - 'automated_collection.py'
      - '.github/workflows/collect-papers.yml'

jobs:
  collect-papers:
    runs-on: ubuntu-latest
    
    # [변경] 실행 시간 제한을 2시간(120분)으로 늘렸습니다. 필요에 따라 조절할 수 있습니다.
    timeout-minutes: 120
    
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # Python 설정 - pyproject.toml의 requires-python에 맞춰 3.9 사용
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    # [변경] 공식 액션을 사용하여 uv를 설치하고 캐시를 활성화합니다.
    - name: Install uv and Enable Cache
      uses: astral-sh/setup-uv@v1
      with:
        # 내장 캐시 기능을 활성화하여 다음 실행 속도를 높입니다.
        enable-cache: true

    # [변경] 여러 pip 명령어를 하나의 uv 명령어로 통합합니다.
    - name: Install dependencies
      # CI 환경에서는 lockfile을 업데이트하고 sync 실행
      # 프로덕션에서는 정확한 버전 재현을 위해 lock 파일 사용
      run: |
        if [ -f "uv.lock" ]; then
          echo "Lockfile exists, attempting locked sync..."
          uv sync --locked --all-extras --dev || {
            echo "Locked sync failed, updating lockfile..."
            uv lock
            uv sync --all-extras --dev
          }
        else
          echo "No lockfile found, creating and syncing..."
          uv lock
          uv sync --all-extras --dev
        fi

    - name: Validate configuration
      # [변경] 'uv run'을 사용하여 uv가 관리하는 환경에서 스크립트를 실행합니다.
      run: uv run python -c "
        from src.pubmed_miner.utils.config_manager import ConfigurationManager;
        config_manager = ConfigurationManager();
        config_manager.validate_config();
        print('Configuration validation successful')
        "
    
    - name: Create logs directory
      run: mkdir -p logs
    
    - name: Run automated collection
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PUBMED_EMAIL: ${{ secrets.PUBMED_EMAIL || 'partrita@gmail.com' }}
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        
      # uv run을 사용하여 스크립트를 실행합니다.
      run: |
        echo "Starting automated essential papers collection..."
        echo "Repository: $GITHUB_REPOSITORY"
        echo "Triggered by: $GITHUB_ACTOR"
        echo "Run ID: $GITHUB_RUN_ID"
        echo "Log level: $LOG_LEVEL"
        uv run python automated_collection.py
    
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: collection-logs-${{ github.run_id }}
        path: logs/
        retention-days: 30
    
    - name: Report results
      if: always()
      run: |
        echo "=== Workflow Summary ==="
        if [ -f "logs/automated_collection.log" ]; then
          echo "Log file contents:"
          tail -n 50 logs/automated_collection.log
        else
          echo "No log file found"
        fi
        echo "=== End Summary ==="
