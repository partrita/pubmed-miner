name: Essential Papers Collection

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level for execution'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR
  push:
    branches: [ main ]
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - 'config/**'
      - 'src/**'
      - 'automated_collection.py'
      - '.github/workflows/collect-papers.yml'

jobs:
  collect-papers:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install uv and Enable Cache
      uses: astral-sh/setup-uv@v1
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        if [ -f "uv.lock" ]; then
          echo "Lockfile exists, attempting locked sync..."
          uv sync --locked --all-extras --dev || {
            echo "Locked sync failed, updating lockfile..."
            uv lock
            uv sync --all-extras --dev
          }
        else
          echo "No lockfile found, creating and syncing..."
          uv lock
          uv sync --all-extras --dev
        fi

    - name: Validate configuration
      run: uv run python scripts/validate_config.py
    
    - name: Create logs directory
      run: mkdir -p logs
    
    - name: Run automated collection
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PUBMED_EMAIL: ${{ secrets.PUBMED_EMAIL || 'partrita@gmail.com' }}
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_RUN_ID: ${{ github.run_id }}
      run: |
        echo "Starting automated essential papers collection..."
        uv run python automated_collection.py > logs/collection_output.txt 2>&1
    
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: collection-logs-${{ github.run_id }}
        path: logs/
        retention-days: 30
    
    - name: Report results
      if: always()
      run: |
        echo "=== Workflow Summary ==="
        if [ -f "logs/automated_collection.log" ]; then
          echo "Log file contents:"
          tail -n 50 logs/automated_collection.log
        else
          echo "No log file found"
        fi
        echo "=== End Summary ==="

    - name: Create or Update Issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const newBody = fs.readFileSync('logs/collection_output.txt', 'utf8');
          const issueTitle = "📚 Essential Papers Collection Report";

          // 동일 제목의 열린 issue 검색
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: "open",
            labels: "automated-report"
          });

          const existing = issues.find(issue => issue.title === issueTitle);
          
          if (existing) {
            console.log(`Appending to existing issue #${existing.number}`);
            const updatedBody = `${existing.body}\n\n---\n\n### Update (${new Date().toISOString()})\n${newBody}`;
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existing.number,
              body: updatedBody
            });
          } else {
            console.log("Creating new issue");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: `### Initial Report (${new Date().toISOString()})\n${newBody}`,
              labels: ["automated-report"]
            });
          }
